---
- name: Apply label and taint to all Kubernetes nodes
  hosts: local
  gather_facts: false

  tasks:
    - name: Get the list of all Kubernetes nodes
      shell: kubectl get nodes | awk '{print $1}'
      register: node_list

    - name: Remove header from node list
      set_fact:
        nodes: "{{ node_list.stdout_lines[1:] }}"

    - name: Label each node with control-plane role
      loop: "{{ nodes }}"
      command: kubectl label node {{ item }} node-role.kubernetes.io/control-plane=true --overwrite

    - name: Taint each control-plane node
      loop: "{{ nodes }}"
      command: kubectl taint nodes {{ item }} node-role.kubernetes.io/control-plane=:NoSchedule --overwrite

    - name: Verify the label and taint changes
      command: kubectl get nodes --show-labels
      register: verify_output

    - name: Display verification output
      debug:
        var: verify_output.stdout_lines

